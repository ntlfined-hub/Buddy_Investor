<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Buddy Picker ¬∑ Sites/GitHub Ready</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-from:#f8fafc; --bg-to:#f1f5f9; --card:#fff; --line:#e5e7eb;
      --text:#0f172a; --muted:#64748b; --primary:#1a1a1a; --accent:#6366f1;
      --success:#10b981; --error:#ef4444;
    }
    body{ font-family:'Inter',system-ui,-apple-system,'Segoe UI',sans-serif; background:linear-gradient(160deg,var(--bg-from),var(--bg-to)); }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 10px 30px rgba(2,6,23,.06) }
    .btn{ border-radius:12px; padding:.9rem 1.1rem; font-weight:600; transition:.2s }
    .btn-accent{ background:var(--accent); color:#fff } .btn-accent:hover{ filter:brightness(1.05) }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .input{ border:1px solid var(--line); border-radius:12px; padding:.9rem 1rem; outline:none; width:100% }
    .input:focus{ box-shadow:0 0 0 4px rgba(99,102,241,.15); border-color:#c7d2fe }
    .toast{ position:fixed; right:16px; top:16px; background:#111827; color:#fff; padding:.75rem 1rem; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.15); transform:translateY(-10px); opacity:0; transition:.25s }
    .toast.show{ opacity:1; transform:translateY(0) }
    .badge{ font-size:.8rem; padding:.25rem .6rem; border-radius:999px; background:#eef2ff; color:#334155; border:1px solid #e5e7eb }

    /* Loading overlay */
    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(15,23,42,.35); backdrop-filter:blur(3px); z-index:50 }
    .overlay.show{ display:flex }
    .spinner{ width:42px; height:42px; border:3px solid #e5e7eb; border-top-color:#6366f1; border-radius:50%; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }
  </style>
</head>
<body class="min-h-screen">
  <header class="sticky top-0 z-10 backdrop-blur bg-white/70 border-b border-slate-200">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="font-bold text-lg">Buddy Picker</div>
      <div class="flex items-center gap-2 text-sm text-slate-600">
        <span id="roundBadge" class="badge">Round: ‚Äî</span>
        <span id="lastFetch" class="badge">Last fetch: ‚Äî</span>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-6">
    <!-- Inputs -->
    <section class="card p-6">
      <h1 class="text-xl font-semibold mb-1">‡∏´‡∏≤ Buddy</h1>
      <p class="text-slate-500 mb-5">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏´‡∏≤ Buddy‚Äù ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>

      <div class="grid gap-4">
        <div>
          <div class="flex items-center justify-between">
            <label class="block text-sm text-slate-600 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ (Name)</label>
            <button id="btnReloadUsers" class="text-sm underline decoration-dotted">Reload ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
          </div>
          <select id="selName" class="input"></select>
          <div class="text-xs text-slate-500 mt-1" id="userCount">‚Äî</div>
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (EmpID)</label>
          <input id="inpEmp" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1001" inputmode="numeric" autocomplete="off"/>
        </div>
      </div>

      <div class="mt-5 flex items-center gap-2">
        <label class="flex items-center gap-2 text-sm text-slate-600">
          <input id="remember" type="checkbox" class="w-4 h-4"> ‡∏à‡∏≥‡∏â‡∏±‡∏ô‡πÑ‡∏ß‡πâ
        </label>
        <div id="loginStatus" class="text-sm text-slate-600 ml-auto"></div>
      </div>

      <div class="mt-5">
        <button id="btnFind" class="btn btn-accent w-full">‡∏´‡∏≤ Buddy</button>
        <div id="drawHint" class="text-sm text-slate-600 mt-2"></div>
      </div>

      <div id="result" class="mt-6 hidden">
        <div class="text-sm text-slate-500 mb-1">Your Buddy</div>
        <div class="text-2xl font-bold" id="buddyName">‚Äî</div>
        <div class="text-slate-500" id="buddyEmp">‚Äî</div>
        <div class="mt-4 text-sm text-slate-600">* ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏à‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà)</div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- Loading overlay -->
  <div id="overlay" class="overlay">
    <div class="card p-5 flex items-center gap-3">
      <div class="spinner"></div>
      <div class="text-slate-700 font-medium" id="overlayMsg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>
    </div>
  </div>

  <script>
    /* ===== CONFIG ===== */
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxoE8n8ZiTJu_dDnSHmn6mjOF27z-XEvQpPHVIgyjKG2R00hPHHjFkN7JHCz6XzdFjWPA/exec"; // /exec ‡∏Ç‡∏≠‡∏á deployment ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    /* ================== */

    // JSONP helper (cache-busting + retry)
    function jsonp(op, params={}, {timeout=15000, retries=1} = {}){
      return new Promise((resolve, reject)=>{
        const tryOnce = ()=>{
          const callback = "cb_" + Math.random().toString(36).slice(2);
          const url = new URL(WEB_APP_URL);
          url.searchParams.set("op", op);
          url.searchParams.set("callback", callback);
          url.searchParams.set("nocache", Date.now());
          Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));

          const s = document.createElement("script");
          s.src = url.toString();
          s.async = true;

          const timer = setTimeout(()=>{ cleanup(); onErr(new Error("JSONP timeout")); }, timeout);
          function cleanup(){ clearTimeout(timer); try{ delete window[callback]; }catch(e){} s.remove(); }
          function onErr(err){ if (retries>0){ retries-=1; setTimeout(()=>tryOnce(), 400); } else { reject(err); } }

          window[callback] = (data)=>{ cleanup(); resolve(data); };
          s.onerror = ()=>{ cleanup(); onErr(new Error("JSONP error")); };
          document.body.appendChild(s);
        };
        tryOnce();
      });
    }

    // UI refs
    const $ = (s)=>document.querySelector(s);
    const selName=$("#selName"), inpEmp=$("#inpEmp"), remember=$("#remember");
    const btnFind=$("#btnFind"), btnReloadUsers=$("#btnReloadUsers");
    const loginStatus=$("#loginStatus"), userCount=$("#userCount");
    const buddyName=$("#buddyName"), buddyEmp=$("#buddyEmp"), resultBox=$("#result"), drawHint=$("#drawHint");
    const roundBadge=$("#roundBadge"), lastFetch=$("#lastFetch");
    const overlay=$("#overlay"), overlayMsg=$("#overlayMsg"), toastBox=$("#toast");

    function toast(msg, ok=true){ toastBox.textContent=msg; toastBox.style.background= ok?"#111827":"#ef4444"; toastBox.classList.add("show"); setTimeout(()=>toastBox.classList.remove("show"), 2200); }
    function stamp(){ lastFetch.textContent = "Last fetch: " + new Date().toLocaleString(); }
    function showLoading(msg="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶"){ overlayMsg.textContent=msg; overlay.classList.add("show"); }
    function hideLoading(){ overlay.classList.remove("show"); }

    function saveLocal(){
      if (!remember.checked) return;
      localStorage.setItem("bp_emp", inpEmp.value.trim());
      localStorage.setItem("bp_sel", selName.value);
    }
    function loadLocal(){
      const emp = localStorage.getItem("bp_emp")||"";
      if (emp) { inpEmp.value = emp; remember.checked = true; }
      const sel = localStorage.getItem("bp_sel");
      if (sel && selName.options.length) selName.value = sel;
    }
    function parseSelected(){
      const v = selName.value;
      if (!v) return null;
      const [empId, name] = v.split(":::");
      return { empId, name };
    }
    function fillUsers(users, round){
      selName.innerHTML="";
      const o0=document.createElement("option");
      o0.value=""; o0.textContent="‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‚Äî";
      selName.appendChild(o0);
      users.forEach(u=>{
        const o=document.createElement("option");
        o.value = `${u.empId}:::${u.name}`;
        o.textContent = u.name ? u.name : u.empId;  // ‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        selName.appendChild(o);
      });
      userCount.textContent = `‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${users.length} ‡∏Ñ‡∏ô`;
      if (round) roundBadge.textContent = `Round: ${round}`;
      loadLocal();
      stamp();
    }
    function showBuddy(name, emp){
      buddyName.textContent = name || "‚Äî";
      buddyEmp.textContent  = emp ? `EmpID: ${emp}` : "‚Äî";
      resultBox.classList.remove("hidden");
    }

    async function loadUsers(){
      try{
        showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‚Ä¶");
        const data = await jsonp("listUsers", {}, {retries:2});
        if (data.ok){ fillUsers(data.users||[], data.round); }
        else { fillUsers([], "‚Äî"); toast("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", false); }
      } catch(e){ console.error(e); toast("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", false); }
      finally{ hideLoading(); }
    }

    // ‡∏£‡∏ß‡∏° flow: login -> (show assigned or draw) ‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    btnFind.onclick = async ()=>{
      const selected = parseSelected();
      if (!selected){ toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠", false); return; }
      const emp = inpEmp.value.trim();
      if (!emp) { toast("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", false); return; }
      if (emp !== selected.empId){ toast("‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", false); return; }

      btnFind.disabled = true;
      try{
        showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶");
        // 1) login
        const loginRes = await jsonp("login", { name:selected.name, empId: emp }, {retries:1});
        stamp();
        if (!loginRes.ok){ toast(loginRes.error || "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", false); return; }

        loginStatus.textContent = `‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô: ${loginRes.user.name} (${loginRes.user.empId}) ¬∑ Round ${loginRes.round||"‚Äî"}`;
        saveLocal();

        // 2) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏¢
        if (loginRes.assigned){
          hideLoading();
          showBuddy(loginRes.assigned.buddyName, loginRes.assigned.buddyEmpId);
          drawHint.textContent = "‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ";
          toast("‡∏î‡∏∂‡∏á‡∏ú‡∏•‡πÄ‡∏î‡∏¥‡∏°", true);
          return;
        }

        // 3) ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢ -> ‡∏™‡∏∏‡πà‡∏°
        overlayMsg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°‡∏´‡∏≤ Buddy‚Ä¶";
        const drawRes = await jsonp("drawBuddy", { empId: selected.empId }, {retries:1});
        stamp();
        if (drawRes.ok && drawRes.assigned){
          showBuddy(drawRes.assigned.buddyName, drawRes.assigned.buddyEmpId);
          drawHint.textContent = "‡∏™‡∏∏‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
          toast("‡πÑ‡∏î‡πâ Buddy ‡πÅ‡∏•‡πâ‡∏ß üéâ");
        } else {
          const msg = drawRes.error==="NO_CANDIDATE_LEFT" ? "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß" : (drawRes.error||"‡∏à‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          toast(msg, false);
        }
      } catch(err){
        console.error(err);
        toast("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", false);
      } finally{
        hideLoading();
        btnFind.disabled = false;
      }
    };

    // Events
    btnReloadUsers.onclick = loadUsers;

    // Init
    loadUsers(); // preload ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ + ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≠‡∏ö
  </script>
</body>
</html>
