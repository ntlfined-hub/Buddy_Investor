<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
  <title>Buddy Picker ¬∑ Mobile First</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-from:#f8fafc; --bg-to:#f1f5f9; --card:#ffffff; --line:#e5e7eb;
      --text:#0f172a; --muted:#64748b; --accent:#6366f1; --accent-2:#4f46e5;
      --success:#10b981; --error:#ef4444;
    }
    body{ font-family:'Inter',system-ui,-apple-system,'Segoe UI',sans-serif; background:linear-gradient(160deg,var(--bg-from),var(--bg-to)); color:var(--text); }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:18px; box-shadow:0 10px 30px rgba(2,6,23,.06) }
    .btn{ border-radius:14px; padding:.95rem 1.1rem; font-weight:700; transition:transform .08s ease; min-height:48px; }
    .btn:active{ transform:translateY(1px) }
    .btn-primary{ background:var(--accent); color:#fff } .btn-primary:hover{ filter:brightness(1.05) }
    .btn-ghost{ background:#fff; border:1px solid var(--line); color:#0f172a }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none!important }
    .input{ border:1px solid var(--line); border-radius:14px; padding:0.9rem 1rem; outline:none; width:100%; font-size:16px; /* ‡∏Å‡∏±‡∏ô iOS zoom */ }
    .input:focus{ box-shadow:0 0 0 5px rgba(99,102,241,.15); border-color:#c7d2fe }
    .label{ font-size:14px; color:#334155; font-weight:600 }
    .hint{ font-size:13px; color:#64748b }
    .toast{ position:fixed; right:16px; top:16px; background:#111827; color:#fff; padding:.8rem 1rem; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.15); transform:translateY(-10px); opacity:0; transition:.25s; z-index:60 }
    .toast.show{ opacity:1; transform:translateY(0) }

    /* Loading overlay (mobile-friendly) */
    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(15,23,42,.35); backdrop-filter:blur(3px); z-index:50; padding:24px }
    .overlay.show{ display:flex }
    .spinner{ width:44px; height:44px; border:3px solid #e5e7eb; border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    /* Buddy card (mobile) */
    .buddy-card{ display:flex; align-items:center; gap:14px; padding:14px; border:1px solid var(--line); border-radius:16px; background:#fff }
    .avatar{ width:48px; height:48px; border-radius:999px; display:grid; place-items:center; font-weight:800; color:#fff; background:linear-gradient(135deg,var(--accent),var(--accent-2)) }

    /* Safe area bottom padding */
    .safe-bottom{ padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px)); }
  </style>
</head>
<body class="min-h-screen">
  <header class="sticky top-0 z-10 backdrop-blur bg-white/80 border-b border-slate-200">
    <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-center">
      <div class="font-bold text-lg">Buddy Picker</div>
    </div>
  </header>

  <main class="max-w-md mx-auto px-4 py-4 safe-bottom">
    <section class="card p-5">
      <h1 class="text-[20px] font-bold">‡∏´‡∏≤ Buddy</h1>
      <p class="hint mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô Buddy</p>

      <div class="mt-4 grid gap-4">
        <div>
          <div class="flex items-center justify-between mb-1.5">
            <label class="label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ (Name)</label>
            <button id="btnReloadUsers" class="hint underline">Reload</button>
          </div>
          <select id="selName" class="input"></select>
          <div class="hint mt-1" id="userCount">‚Äî</div>
        </div>

        <div>
          <label class="label mb-1.5 block">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (EmpID)</label>
          <input id="inpEmp" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1001" inputmode="numeric" autocomplete="off"/>
        </div>

        <label class="flex items-center gap-2 hint select-none">
          <input id="remember" type="checkbox" class="w-5 h-5 accent-indigo-600"> ‡∏à‡∏≥‡∏â‡∏±‡∏ô‡πÑ‡∏ß‡πâ
        </label>
      </div>

      <!-- Primary CTA -->
      <div class="mt-4">
        <button id="btnFind" class="btn btn-primary w-full text-[16px]">‡∏´‡∏≤ Buddy</button>
        <div id="drawHint" class="hint mt-2"></div>
      </div>

      <!-- Status line (compact for mobile) -->
      <div id="loginStatus" class="hint mt-3"></div>

      <!-- Result -->
      <div id="result" class="mt-5 hidden">
        <div class="hint mb-2">Your Buddy</div>
        <div class="buddy-card">
          <div class="avatar" id="buddyAvatar">?</div>
          <div>
            <div class="text-[18px] font-extrabold leading-tight" id="buddyName">‚Äî</div>
            <div class="hint leading-tight" id="buddyEmp">‚Äî</div>
          </div>
        </div>
        <div class="hint mt-3">* ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏à‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà)</div>
      </div>
    </section>

    <p class="hint mt-3 text-center" id="roundBadge">Round: ‚Äî ¬∑ <span id="lastFetch">Last fetch: ‚Äî</span></p>
  </main>

  <div id="toast" class="toast"></div>

  <!-- Loading overlay -->
  <div id="overlay" class="overlay">
    <div class="card p-5 flex items-center gap-3 w-full max-w-[320px]">
      <div class="spinner"></div>
      <div class="text-slate-700 font-semibold" id="overlayMsg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>
    </div>
  </div>

  <script>
    /* ===== CONFIG ===== */
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxoE8n8ZiTJu_dDnSHmn6mjOF27z-XEvQpPHVIgyjKG2R00hPHHjFkN7JHCz6XzdFjWPA/exec"; // /exec ‡∏Ç‡∏≠‡∏á deployment ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    /* ================== */

    // JSONP helper (cache-busting + retry)
    function jsonp(op, params={}, {timeout=15000, retries=1} = {}){
      return new Promise((resolve, reject)=>{
        const tryOnce = ()=>{
          const callback = "cb_" + Math.random().toString(36).slice(2);
          const url = new URL(WEB_APP_URL);
          url.searchParams.set("op", op);
          url.searchParams.set("callback", callback);
          url.searchParams.set("nocache", Date.now());
          Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));

          const s = document.createElement("script");
          s.src = url.toString();
          s.async = true;

          const timer = setTimeout(()=>{ cleanup(); onErr(new Error("JSONP timeout")); }, timeout);
          function cleanup(){ clearTimeout(timer); try{ delete window[callback]; }catch(e){} s.remove(); }
          function onErr(err){ if (retries>0){ retries-=1; setTimeout(()=>tryOnce(), 350); } else { reject(err); } }

          window[callback] = (data)=>{ cleanup(); resolve(data); };
          s.onerror = ()=>{ cleanup(); onErr(new Error("JSONP error")); };
          document.body.appendChild(s);
        };
        tryOnce();
      });
    }

    // UI refs
    const $ = (s)=>document.querySelector(s);
    const selName=$("#selName"), inpEmp=$("#inpEmp"), remember=$("#remember");
    const btnFind=$("#btnFind"), btnReloadUsers=$("#btnReloadUsers");
    const loginStatus=$("#loginStatus"), userCount=$("#userCount");
    const buddyName=$("#buddyName"), buddyEmp=$("#buddyEmp"), resultBox=$("#result"), drawHint=$("#drawHint");
    const roundBadge=$("#roundBadge"), lastFetch=$("#lastFetch");
    const overlay=$("#overlay"), overlayMsg=$("#overlayMsg"), toastBox=$("#toast");
    const buddyAvatar=$("#buddyAvatar");

    // Helpers
    function toast(msg, ok=true){ toastBox.textContent=msg; toastBox.style.background= ok?"#111827":"#ef4444"; toastBox.classList.add("show"); setTimeout(()=>toastBox.classList.remove("show"), 2000); }
    function stamp(){ lastFetch.textContent = "Last fetch: " + new Date().toLocaleString(); }
    function showLoading(msg="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶"){ overlayMsg.textContent=msg; overlay.classList.add("show"); }
    function hideLoading(){ overlay.classList.remove("show"); }
    function initials(name=""){ const t=(name||"").trim(); if(!t) return "?"; const p=t.split(/\s+/); return (p[0][0]||"").toUpperCase() + (p[1]?.[0]||"").toUpperCase(); }

    function saveLocal(){
      if (!remember.checked) return;
      localStorage.setItem("bp_emp", inpEmp.value.trim());
      localStorage.setItem("bp_sel", selName.value);
    }
    function loadLocal(){
      const emp = localStorage.getItem("bp_emp")||"";
      if (emp) { inpEmp.value = emp; remember.checked = true; }
      const sel = localStorage.getItem("bp_sel");
      if (sel && selName.options.length) selName.value = sel;
    }
    function parseSelected(){
      const v = selName.value;
      if (!v) return null;
      const [empId, name] = v.split(":::");
      return { empId, name };
    }
    function fillUsers(users, round){
      selName.innerHTML="";
      const o0=document.createElement("option");
      o0.value=""; o0.textContent="‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‚Äî";
      selName.appendChild(o0);
      users.forEach(u=>{
        const o=document.createElement("option");
        o.value = `${u.empId}:::${u.name}`;
        o.textContent = u.name ? u.name : u.empId; // ‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        selName.appendChild(o);
      });
      userCount.textContent = `‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${users.length} ‡∏Ñ‡∏ô`;
      if (round) roundBadge.textContent = `Round: ${round} ¬∑ `;
      loadLocal();
      stamp();
    }
    function showBuddy(name, emp){
      buddyName.textContent = name || "‚Äî";
      buddyEmp.textContent  = emp ? `EmpID: ${emp}` : "‚Äî";
      buddyAvatar.textContent = initials(name);
      resultBox.classList.remove("hidden");
    }

    async function loadUsers(){
      try{
        showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‚Ä¶");
        const data = await jsonp("listUsers", {}, {retries:2});
        if (data.ok){ fillUsers(data.users||[], data.round); }
        else { fillUsers([], "‚Äî"); toast("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", false); }
      } catch(e){ console.error(e); toast("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", false); }
      finally{ hideLoading(); }
    }

    // ‡∏£‡∏ß‡∏° flow: login -> (show assigned or draw) ‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    btnFind.onclick = async ()=>{
      const selected = parseSelected();
      if (!selected){ toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠", false); selName.focus(); return; }
      const emp = inpEmp.value.trim();
      if (!emp) { toast("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", false); inpEmp.focus(); return; }

      btnFind.disabled = true;
      try{
        showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶");
        const loginRes = await jsonp("login", { name:selected.name, empId: emp }, {retries:1});
        stamp();
        if (!loginRes.ok){ toast(loginRes.error || "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", false); return; }

        loginStatus.textContent = `‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô: ${loginRes.user.name} (${loginRes.user.empId}) ¬∑ ‡∏£‡∏≠‡∏ö ${loginRes.round||"‚Äî"}`;
        saveLocal();

        // ‡πÄ‡∏Ñ‡∏¢‡∏à‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÇ‡∏ä‡∏ß‡πå‡∏ú‡∏•‡πÄ‡∏î‡∏¥‡∏°
        if (loginRes.assigned){
          hideLoading();
          showBuddy(loginRes.assigned.buddyName, loginRes.assigned.buddyEmpId);
          drawHint.textContent = "‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ";
          toast("‡∏î‡∏∂‡∏á‡∏ú‡∏•‡πÄ‡∏î‡∏¥‡∏°", true);
          return;
        }

        // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢ ‚Üí ‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
        overlayMsg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°‡∏´‡∏≤ Buddy‚Ä¶";
        const drawRes = await jsonp("drawBuddy", { empId: selected.empId }, {retries:1});
        stamp();
        if (drawRes.ok && drawRes.assigned){
          showBuddy(drawRes.assigned.buddyName, drawRes.assigned.buddyEmpId);
          drawHint.textContent = "‡∏™‡∏∏‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
          toast("‡πÑ‡∏î‡πâ Buddy ‡πÅ‡∏•‡πâ‡∏ß üéâ");
        } else {
          const msg = drawRes.error==="NO_CANDIDATE_LEFT" ? "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß" : (drawRes.error||"‡∏à‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          toast(msg, false);
        }
      } catch(err){
        console.error(err);
        toast("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", false);
      } finally{
        hideLoading();
        btnFind.disabled = false;
      }
    };

    // Reload ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
    btnReloadUsers.onclick = loadUsers;

    // Init
    loadUsers();
  </script>
</body>
</html>
